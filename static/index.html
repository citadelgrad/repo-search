<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Repo Search</title>
<style>
  :root {
    --bg: #0d1117;
    --bg2: #161b22;
    --bg3: #21262d;
    --border: #30363d;
    --text: #c9d1d9;
    --text-muted: #8b949e;
    --accent: #58a6ff;
    --accent-dim: #1f6feb;
    --green: #3fb950;
    --red: #f85149;
    --yellow: #d29922;
    --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
  }

  .container { max-width: 1100px; margin: 0 auto; padding: 0 24px; }

  header {
    border-bottom: 1px solid var(--border);
    padding: 16px 0;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  header h1 {
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
  }

  header h1 span { color: var(--accent); }

  nav {
    display: flex;
    gap: 8px;
    margin-left: auto;
  }

  nav button {
    background: transparent;
    color: var(--text-muted);
    border: 1px solid var(--border);
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
  }

  nav button.active, nav button:hover {
    background: var(--bg3);
    color: var(--text);
    border-color: var(--text-muted);
  }

  .page { display: none; padding: 24px 0; }
  .page.active { display: block; }

  /* ── Search Page ─────────────────────────────── */
  .search-box {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .search-box input {
    flex: 1;
    background: var(--bg2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 15px;
    outline: none;
  }

  .search-box input:focus { border-color: var(--accent); }

  .search-box button {
    background: var(--accent-dim);
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }

  .search-box button:hover { background: var(--accent); }

  .search-options {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .search-options label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: var(--text-muted);
    cursor: pointer;
  }

  .search-options input[type="checkbox"] {
    accent-color: var(--accent);
  }

  /* ── Repo Filter Bar ─────────────────────────── */
  .repo-filter {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
    align-items: center;
  }

  .repo-filter-label {
    font-size: 13px;
    color: var(--text-muted);
    margin-right: 4px;
    white-space: nowrap;
  }

  .repo-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--bg2);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }

  .repo-chip:hover {
    border-color: var(--text-muted);
    color: var(--text);
  }

  .repo-chip.selected {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: #fff;
  }

  .repo-chip .chip-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-muted);
    flex-shrink: 0;
  }

  .repo-chip.selected .chip-dot {
    background: var(--green);
  }

  .repo-chip.status-pending .chip-dot {
    background: var(--yellow);
  }

  .repo-filter-actions {
    display: flex;
    gap: 4px;
    margin-left: 4px;
  }

  .repo-filter-actions button {
    background: transparent;
    border: none;
    color: var(--accent);
    font-size: 11px;
    cursor: pointer;
    padding: 2px 4px;
  }

  .repo-filter-actions button:hover {
    text-decoration: underline;
  }

  .repo-filter-empty {
    font-size: 12px;
    color: var(--text-muted);
    font-style: italic;
  }

  .search-meta {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 12px;
  }

  /* ── File-grouped result cards ─────────────────── */
  .file-result {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
  }

  .file-result-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    font-size: 13px;
    cursor: pointer;
    user-select: none;
    transition: background 0.1s;
  }

  .file-result-header:hover { background: var(--bg3); }

  .file-result-header .chevron {
    color: var(--text-muted);
    font-size: 12px;
    transition: transform 0.15s;
    flex-shrink: 0;
    width: 16px;
    text-align: center;
  }

  .file-result.collapsed .chevron { transform: rotate(-90deg); }
  .file-result.collapsed .file-result-body { display: none; }

  .file-result-header .file-path {
    color: var(--accent);
    font-family: var(--font-mono);
    font-weight: 500;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .file-result-header .lang-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--text-muted);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .file-result-header .lang-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .file-result-header .match-count {
    font-size: 11px;
    padding: 1px 7px;
    border-radius: 10px;
    background: var(--bg3);
    color: var(--text-muted);
    font-weight: 500;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .file-result-header .repo-name {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 500;
    white-space: nowrap;
    margin-left: auto;
    flex-shrink: 0;
  }

  .file-result-body { border-top: 1px solid var(--border); }

  .code-table {
    width: 100%;
    border-collapse: collapse;
    font-family: var(--font-mono);
    font-size: 12.5px;
    line-height: 1.5;
  }

  .code-line .line-num {
    padding: 0 10px 0 14px;
    text-align: right;
    color: var(--text-muted);
    user-select: none;
    white-space: nowrap;
    vertical-align: top;
    width: 1px;
    opacity: 0.6;
  }

  .code-line .line-code {
    padding: 0 14px 0 8px;
    white-space: pre;
    overflow-x: auto;
    color: var(--text);
  }

  .code-line.match-line { background: rgba(210, 153, 34, 0.08); }

  .code-line.match-line .line-num { opacity: 1; color: var(--yellow); }

  mark {
    background: rgba(210, 153, 34, 0.35);
    color: inherit;
    border-radius: 2px;
    padding: 0 1px;
  }

  .region-separator td {
    padding: 2px 0;
    text-align: center;
    color: var(--text-muted);
    font-size: 11px;
    font-family: var(--font-mono);
    border-top: 1px dashed var(--border);
    border-bottom: 1px dashed var(--border);
    background: var(--bg);
    user-select: none;
  }

  .code-region.hidden { display: none; }

  .show-more-btn {
    display: block;
    width: 100%;
    padding: 7px 14px;
    background: transparent;
    border: none;
    border-top: 1px solid var(--border);
    color: var(--accent);
    font-size: 12px;
    cursor: pointer;
    text-align: center;
    font-family: inherit;
  }

  .show-more-btn:hover { background: var(--bg3); }

  /* ── Repos Page ──────────────────────────────── */
  .add-repo {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
  }

  .add-repo input {
    flex: 1;
    background: var(--bg2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
  }

  .add-repo input:focus { border-color: var(--accent); }

  .add-repo button {
    background: var(--green);
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
  }

  .repo-list { display: grid; gap: 12px; }

  .repo-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .repo-card .info { flex: 1; }
  .repo-card .name { font-weight: 600; font-size: 15px; }
  .repo-card .url {
    font-size: 12px;
    color: var(--text-muted);
    font-family: var(--font-mono);
    word-break: break-all;
  }

  .repo-card .meta {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .status-badge {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: 500;
    text-transform: uppercase;
  }

  .status-badge.ready { background: #0d3117; color: var(--green); }
  .status-badge.cloning, .status-badge.indexing, .status-badge.embedding { background: #2d1b00; color: var(--yellow); }
  .status-badge.error { background: #3d1216; color: var(--red); }

  .repo-card .delete-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--red);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
  }

  .repo-card .delete-btn:hover {
    background: #3d1216;
    border-color: var(--red);
  }

  .repo-card .reindex-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--accent);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
  }

  .repo-card .reindex-btn:hover {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: #fff;
  }

  /* ── Settings Page ───────────────────────────── */
  .settings-form {
    max-width: 600px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 6px;
    color: var(--text-muted);
  }

  .form-group input, .form-group select {
    width: 100%;
    background: var(--bg2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
  }

  .form-group input:focus, .form-group select:focus {
    border-color: var(--accent);
  }

  .settings-form button {
    background: var(--accent-dim);
    color: #fff;
    border: none;
    padding: 10px 24px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .empty-state h3 {
    font-size: 18px;
    margin-bottom: 8px;
    color: var(--text);
  }

  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 12px 18px;
    border-radius: 8px;
    font-size: 13px;
    z-index: 100;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
  }

  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }

  .pipeline-info {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    margin-bottom: 20px;
    font-size: 12px;
    color: var(--text-muted);
    font-family: var(--font-mono);
    line-height: 1.8;
  }

  .pipeline-info .step {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .pipeline-info .step .arrow { color: var(--accent); }
  .pipeline-info .step.done .label { color: var(--green); }
  .pipeline-info .step.active .label { color: var(--yellow); }
  .pipeline-info .step .label { color: var(--text-muted); }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><span>repo</span>search</h1>
    <nav>
      <button class="active" data-page="search">Search</button>
      <button data-page="repos">Repos</button>
      <button data-page="settings">Settings</button>
    </nav>
  </header>

  <!-- Search Page -->
  <div class="page active" id="page-search">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Search across repositories..." autofocus>
      <button onclick="doSearch()">Search</button>
    </div>
    <div class="search-options">
      <label><input type="checkbox" id="opt-bm25" checked> BM25 (full-text)</label>
      <label><input type="checkbox" id="opt-vector" checked> Vector (semantic)</label>
      <label><input type="checkbox" id="opt-rerank"> LLM Re-rank + Query Expansion</label>
    </div>

    <div id="repo-filter" class="repo-filter" style="display:none;">
      <span class="repo-filter-label">Repos:</span>
      <div id="repo-chips"></div>
      <div class="repo-filter-actions">
        <button onclick="selectAllRepos()">All</button>
        <button onclick="selectNoRepos()">None</button>
      </div>
    </div>

    <div id="pipeline-status" class="pipeline-info" style="display:none;">
      <div class="step" id="step-expand"><span class="arrow">-></span> <span class="label">Query Expansion</span> <span class="detail"></span></div>
      <div class="step" id="step-bm25"><span class="arrow">-></span> <span class="label">BM25 Search</span> <span class="detail"></span></div>
      <div class="step" id="step-vector"><span class="arrow">-></span> <span class="label">Vector Search</span> <span class="detail"></span></div>
      <div class="step" id="step-rrf"><span class="arrow">-></span> <span class="label">RRF Fusion + Top-rank Bonus</span> <span class="detail"></span></div>
      <div class="step" id="step-rerank"><span class="arrow">-></span> <span class="label">LLM Re-ranking (position-aware blend)</span> <span class="detail"></span></div>
    </div>

    <div id="search-meta" class="search-meta" style="display:none;"></div>
    <div id="search-results"></div>

    <div id="search-empty" class="empty-state">
      <h3>Search your code</h3>
      <p>Add repositories in the Repos tab, then search here with hybrid BM25 + vector + LLM re-ranking.</p>
    </div>
  </div>

  <!-- Repos Page -->
  <div class="page" id="page-repos">
    <div class="add-repo">
      <input type="text" id="repo-url" placeholder="https://github.com/user/repo.git">
      <button onclick="addRepo()">Clone + Index</button>
    </div>
    <div id="repo-list" class="repo-list"></div>
    <div id="repos-empty" class="empty-state">
      <h3>No repositories yet</h3>
      <p>Paste a git URL above to clone and index a repository for search.</p>
    </div>
  </div>

  <!-- Settings Page -->
  <div class="page" id="page-settings">
    <div class="settings-form">
      <h2 style="margin-bottom:20px;font-size:18px;">LLM Configuration</h2>
      <div class="form-group">
        <label>Provider</label>
        <select id="cfg-provider">
          <option value="ollama">Ollama (local)</option>
          <option value="openai">OpenAI-compatible (cloud)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Base URL <small>(set via LLM_BASE_URL env var)</small></label>
        <input type="text" id="cfg-base-url" placeholder="http://localhost:11434" disabled>
      </div>
      <div class="form-group">
        <label>Chat Model (re-ranking / query expansion)</label>
        <input type="text" id="cfg-chat-model" placeholder="llama3.2">
      </div>
      <div class="form-group">
        <label>Embedding Model</label>
        <input type="text" id="cfg-embed-model" placeholder="nomic-embed-text">
      </div>
      <div class="form-group">
        <label>Embedding Dimension</label>
        <input type="number" id="cfg-embed-dim" placeholder="768">
      </div>
      <div class="form-group">
        <label>API Key (only for cloud providers)</label>
        <input type="password" id="cfg-api-key" placeholder="sk-...">
      </div>
      <button onclick="saveConfig()">Save Configuration</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';

// ── Repo Filter State ────────────────────────────
let cachedRepos = [];
let selectedRepoIds = new Set(); // empty = search all

const REPO_COLORS = [
  '#58a6ff', '#3fb950', '#d29922', '#f85149', '#bc8cff',
  '#f78166', '#79c0ff', '#7ee787', '#e3b341', '#ff7b72',
];

function repoColor(idx) {
  return REPO_COLORS[idx % REPO_COLORS.length];
}

function repoColorMap() {
  const map = {};
  cachedRepos.forEach((r, i) => { map[r.id] = repoColor(i); });
  return map;
}

// ── Language Colors (GitHub Linguist) ────────────
const LANG_COLORS = {
  rust:'#dea584',python:'#3572A5',javascript:'#f1e05a',typescript:'#3178c6',
  tsx:'#3178c6',jsx:'#f1e05a',go:'#00ADD8',java:'#b07219',c:'#555555',
  cpp:'#f34b7d',csharp:'#178600',ruby:'#701516',php:'#4F5D95',swift:'#F05138',
  kotlin:'#A97BFF',scala:'#c22d40',r:'#198CE7',lua:'#000080',shell:'#89e051',
  sql:'#e38c00',html:'#e34c26',css:'#563d7c',json:'#292929',yaml:'#cb171e',
  toml:'#9c4221',xml:'#0060ac',text:'#8b949e',protobuf:'#9e7eff',
  graphql:'#e10098',vue:'#41b883',svelte:'#ff3e00',zig:'#ec915c',
  dart:'#00B4AB',nim:'#ffc200',julia:'#a270ba',elixir:'#6e4a7e',
  haskell:'#5e5086',clojure:'#db5855',hcl:'#844fba',nix:'#7e7eff',
};

const LANG_LABELS = {
  rust:'Rust',python:'Python',javascript:'JavaScript',typescript:'TypeScript',
  tsx:'TSX',jsx:'JSX',go:'Go',java:'Java',c:'C',cpp:'C++',csharp:'C#',
  ruby:'Ruby',php:'PHP',swift:'Swift',kotlin:'Kotlin',scala:'Scala',r:'R',
  lua:'Lua',shell:'Shell',sql:'SQL',html:'HTML',css:'CSS',json:'JSON',
  yaml:'YAML',toml:'TOML',xml:'XML',text:'Text',protobuf:'Protobuf',
  graphql:'GraphQL',vue:'Vue',svelte:'Svelte',zig:'Zig',dart:'Dart',
  nim:'Nim',julia:'Julia',elixir:'Elixir',haskell:'Haskell',clojure:'Clojure',
  hcl:'HCL',nix:'Nix',
};

// ── Grouped Results Helpers ──────────────────────

function groupResults(results) {
  const groups = new Map();
  for (const r of results) {
    const key = r.repo_id + ':' + r.file_path;
    if (!groups.has(key)) {
      groups.set(key, {
        repo_id: r.repo_id, repo_name: r.repo_name,
        file_path: r.file_path, language: r.language,
        chunks: [], bestScore: -Infinity,
      });
    }
    const g = groups.get(key);
    g.chunks.push(r);
    const s = r.rerank_score ?? r.combined_score;
    if (s > g.bestScore) g.bestScore = s;
  }
  return Array.from(groups.values()).sort((a, b) => b.bestScore - a.bestScore);
}

function mergeChunksToLineMap(chunks) {
  const map = new Map();
  for (const c of chunks) {
    const lines = c.content.split('\n');
    for (let i = 0; i < lines.length; i++) {
      const lineNum = c.start_line + i;
      if (!map.has(lineNum)) map.set(lineNum, lines[i]);
    }
  }
  return map;
}

function extractMatchRegions(lineMap, query, contextLines) {
  if (contextLines === undefined) contextLines = 3;
  const terms = query.trim().split(/\s+/).filter(Boolean);
  const allLineNums = Array.from(lineMap.keys()).sort((a, b) => a - b);
  if (allLineNums.length === 0) return [];

  // Find lines that match any search term
  const matchSet = new Set();
  for (const ln of allLineNums) {
    const text = lineMap.get(ln).toLowerCase();
    for (const t of terms) {
      if (text.includes(t.toLowerCase())) { matchSet.add(ln); break; }
    }
  }

  // Semantic-only fallback: show first 6 lines as preview
  if (matchSet.size === 0) {
    const preview = allLineNums.slice(0, 6);
    if (preview.length === 0) return [];
    return [{ lines: preview, matchLines: new Set() }];
  }

  // Expand match lines by context
  const includeSet = new Set();
  for (const ln of matchSet) {
    for (let d = -contextLines; d <= contextLines; d++) {
      const n = ln + d;
      if (lineMap.has(n)) includeSet.add(n);
    }
  }

  // Group contiguous included lines into regions
  const included = Array.from(includeSet).sort((a, b) => a - b);
  const regions = [];
  let region = null;
  for (const ln of included) {
    if (!region || ln > region.lines[region.lines.length - 1] + 1) {
      region = { lines: [], matchLines: matchSet };
      regions.push(region);
    }
    region.lines.push(ln);
  }
  return regions;
}

function highlightTerms(escapedText, terms) {
  if (!terms.length) return escapedText;
  const escaped = terms.map(t => esc(t).replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
  const re = new RegExp('(' + escaped.join('|') + ')', 'gi');
  return escapedText.replace(re, '<mark>$1</mark>');
}

function renderGroupedResults(groups, query) {
  const colors = repoColorMap();
  const terms = query.trim().split(/\s+/).filter(Boolean);
  const MAX_VISIBLE_REGIONS = 2;

  return groups.map(g => {
    const lineMap = mergeChunksToLineMap(g.chunks);
    const regions = extractMatchRegions(lineMap, query);
    const langColor = LANG_COLORS[g.language] || '#8b949e';
    const langLabel = LANG_LABELS[g.language] || g.language;
    const c = colors[g.repo_id] || 'var(--text-muted)';

    // Count matching lines
    const matchCount = regions.reduce((sum, r) =>
      sum + r.lines.filter(ln => r.matchLines.has(ln)).length, 0);

    const hiddenCount = regions.length > MAX_VISIBLE_REGIONS ? regions.length - MAX_VISIBLE_REGIONS : 0;

    const regionsHtml = regions.map((region, ri) => {
      const hidden = ri >= MAX_VISIBLE_REGIONS ? ' hidden' : '';
      const rows = region.lines.map(ln => {
        const raw = lineMap.get(ln) || '';
        const isMatch = region.matchLines.has(ln);
        const code = isMatch ? highlightTerms(esc(raw), terms) : esc(raw);
        return `<tr class="code-line${isMatch ? ' match-line' : ''}"><td class="line-num">${ln}</td><td class="line-code">${code}</td></tr>`;
      }).join('');

      const sep = ri > 0 ? '<tr class="region-separator"><td colspan="2">...</td></tr>' : '';
      return `${sep}<tbody class="code-region${hidden}">${rows}</tbody>`;
    }).join('');

    const showMoreBtn = hiddenCount > 0
      ? `<button class="show-more-btn" onclick="showMoreRegions(this)">Show ${hiddenCount} more match region${hiddenCount > 1 ? 's' : ''}</button>`
      : '';

    return `<div class="file-result">
      <div class="file-result-header" onclick="toggleFileResult(this)">
        <span class="chevron">&#9660;</span>
        <span class="file-path" title="${esc(g.file_path)}">${esc(g.file_path)}</span>
        <span class="lang-tag"><span class="lang-dot" style="background:${langColor}"></span>${esc(langLabel)}</span>
        ${matchCount > 0 ? `<span class="match-count">${matchCount} match${matchCount !== 1 ? 'es' : ''}</span>` : ''}
        <span class="repo-name" style="background:${c}22; color:${c}; border:1px solid ${c}44;">${esc(g.repo_name)}</span>
      </div>
      <div class="file-result-body">
        <table class="code-table">${regionsHtml}</table>
        ${showMoreBtn}
      </div>
    </div>`;
  }).join('');
}

function toggleFileResult(headerEl) {
  headerEl.parentElement.classList.toggle('collapsed');
}

function showMoreRegions(btn) {
  const body = btn.parentElement;
  body.querySelectorAll('.code-region.hidden').forEach(el => el.classList.remove('hidden'));
  btn.remove();
}

// ── Navigation ───────────────────────────────────
document.querySelectorAll('nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('page-' + btn.dataset.page).classList.add('active');
    if (btn.dataset.page === 'repos') loadRepos();
    if (btn.dataset.page === 'settings') loadConfig();
    if (btn.dataset.page === 'search') refreshRepoFilter();
  });
});

// ── Repo Filter ──────────────────────────────────
async function refreshRepoFilter() {
  try {
    const resp = await fetch(API + '/api/repos');
    cachedRepos = await resp.json();
  } catch (e) {
    cachedRepos = [];
  }
  renderRepoChips();
}

function renderRepoChips() {
  const filterDiv = document.getElementById('repo-filter');
  const chipsDiv = document.getElementById('repo-chips');

  const readyRepos = cachedRepos.filter(r => r.status === 'ready' || r.status === 'cloning' || r.status === 'indexing' || r.status === 'embedding');

  if (readyRepos.length === 0) {
    filterDiv.style.display = 'none';
    return;
  }

  filterDiv.style.display = 'flex';

  // Remove any selectedRepoIds that no longer exist
  const validIds = new Set(readyRepos.map(r => r.id));
  for (const id of selectedRepoIds) {
    if (!validIds.has(id)) selectedRepoIds.delete(id);
  }

  chipsDiv.innerHTML = readyRepos.map((r, i) => {
    const selected = selectedRepoIds.has(r.id);
    const isPending = r.status === 'cloning' || r.status === 'indexing' || r.status === 'embedding';
    const color = repoColor(i);
    return `<span class="repo-chip ${selected ? 'selected' : ''} ${isPending ? 'status-pending' : ''}"
                  data-id="${r.id}"
                  onclick="toggleRepoChip('${r.id}')"
                  style="${selected ? 'border-color:' + color + '; background:' + color + '22;' : ''}"
                  title="${esc(r.url)}${isPending ? ' (still indexing)' : ''}">
      <span class="chip-dot" style="background:${color}"></span>
      ${esc(r.name)}
    </span>`;
  }).join('');
}

function toggleRepoChip(id) {
  if (selectedRepoIds.has(id)) {
    selectedRepoIds.delete(id);
  } else {
    selectedRepoIds.add(id);
  }
  renderRepoChips();
}

function selectAllRepos() {
  cachedRepos.forEach(r => {
    if (r.status === 'ready') selectedRepoIds.add(r.id);
  });
  renderRepoChips();
}

function selectNoRepos() {
  selectedRepoIds.clear();
  renderRepoChips();
}

function getSelectedRepoIds() {
  // Empty selection means "search all"
  if (selectedRepoIds.size === 0) return null;
  return Array.from(selectedRepoIds);
}

// ── Search ───────────────────────────────────────
document.getElementById('search-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') doSearch();
});

async function doSearch() {
  const query = document.getElementById('search-input').value.trim();
  if (!query) return;

  const useBm25 = document.getElementById('opt-bm25').checked;
  const useVector = document.getElementById('opt-vector').checked;
  const useRerank = document.getElementById('opt-rerank').checked;

  const resultsDiv = document.getElementById('search-results');
  const metaDiv = document.getElementById('search-meta');
  const emptyDiv = document.getElementById('search-empty');
  const pipelineDiv = document.getElementById('pipeline-status');

  emptyDiv.style.display = 'none';
  resultsDiv.innerHTML = '<p style="color:var(--text-muted)"><span class="spinner"></span> Searching...</p>';
  metaDiv.style.display = 'none';

  // Show pipeline status if rerank is enabled
  if (useRerank) {
    pipelineDiv.style.display = 'block';
    document.querySelectorAll('#pipeline-status .step').forEach(s => {
      s.classList.remove('done', 'active');
      s.querySelector('.detail').textContent = '';
    });
    document.getElementById('step-expand').classList.add('active');
    document.getElementById('step-expand').querySelector('.detail').textContent = '...';
  } else {
    pipelineDiv.style.display = 'none';
  }

  try {
    const resp = await fetch(API + '/api/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query,
        limit: 20,
        use_bm25: useBm25,
        use_vector: useVector,
        use_rerank: useRerank,
        repo_ids: getSelectedRepoIds(),
      }),
    });

    if (!resp.ok) {
      const err = await resp.text();
      throw new Error(err);
    }

    const data = await resp.json();

    // Update pipeline status
    if (useRerank) {
      document.querySelectorAll('#pipeline-status .step').forEach(s => s.classList.add('done'));
      document.getElementById('step-bm25').querySelector('.detail').textContent = `(${data.total_bm25_hits} hits)`;
      document.getElementById('step-vector').querySelector('.detail').textContent = `(${data.total_vector_hits} hits)`;
      document.getElementById('step-rrf').querySelector('.detail').textContent = `(top 30)`;
      document.getElementById('step-rerank').querySelector('.detail').textContent = `(${data.results.length} final)`;
      document.getElementById('step-expand').querySelector('.detail').textContent = `(done)`;
    }

    if (data.results.length === 0) {
      metaDiv.style.display = 'block';
      metaDiv.textContent = 'No results found';
      // Safe: static HTML with no user content
      resultsDiv.innerHTML = '<div class="empty-state"><h3>No results found</h3><p>Try a different query or add more repositories.</p></div>';
      return;
    }

    const groups = groupResults(data.results);
    const fileCount = groups.length;
    metaDiv.style.display = 'block';
    metaDiv.textContent = `${data.results.length} results across ${fileCount} file${fileCount !== 1 ? 's' : ''}`;

    // Safe: renderGroupedResults escapes all user content via esc() before HTML insertion
    resultsDiv.innerHTML = renderGroupedResults(groups, query);

  } catch (err) {
    resultsDiv.innerHTML = `<p style="color:var(--red)">Search failed: ${esc(err.message)}</p>`;
  }
}

// ── Repos ────────────────────────────────────────
let repoPolling = null;

async function loadRepos() {
  try {
    const resp = await fetch(API + '/api/repos');
    const repos = await resp.json();

    const listDiv = document.getElementById('repo-list');
    const emptyDiv = document.getElementById('repos-empty');

    if (repos.length === 0) {
      listDiv.innerHTML = '';
      emptyDiv.style.display = 'block';
      return;
    }

    emptyDiv.style.display = 'none';
    listDiv.innerHTML = repos.map(r => {
      const statusClass = typeof r.status === 'string' ? r.status : 'error';
      const statusText = typeof r.status === 'string' ? r.status : `error: ${r.status.error}`;
      const isProcessing = statusText === 'cloning' || statusText === 'indexing' || statusText === 'embedding';
      const isReady = statusText === 'ready';
      const isError = statusClass === 'error';
      const canReindex = isReady || isError;
      return `
        <div class="repo-card">
          <div class="info">
            <div class="name">${esc(r.name)}</div>
            <div class="url">${esc(r.url)}</div>
            <div class="meta">
              ${r.file_count} files | Added ${new Date(r.added_at).toLocaleDateString()}
              ${r.indexed_at ? ' | Indexed ' + new Date(r.indexed_at).toLocaleDateString() : ''}
            </div>
          </div>
          <span class="status-badge ${esc(statusClass)}">${isProcessing ? '<span class="spinner"></span>' : ''}${esc(statusText)}</span>
          ${canReindex ? `<button class="reindex-btn" onclick="reindexRepo('${r.id}')">Re-index</button>` : ''}
          <button class="delete-btn" onclick="deleteRepo('${r.id}')">Delete</button>
        </div>
      `;
    }).join('');

    // Auto-poll if any repos are still processing
    const processing = repos.some(r => r.status === 'cloning' || r.status === 'indexing' || r.status === 'embedding');
    if (processing && !repoPolling) {
      repoPolling = setInterval(loadRepos, 3000);
    } else if (!processing && repoPolling) {
      clearInterval(repoPolling);
      repoPolling = null;
    }
  } catch (err) {
    toast('Failed to load repos: ' + err.message);
  }
}

async function addRepo() {
  const input = document.getElementById('repo-url');
  const url = input.value.trim();
  if (!url) return;

  try {
    const resp = await fetch(API + '/api/repos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url }),
    });

    if (!resp.ok) {
      const err = await resp.text();
      throw new Error(err);
    }

    input.value = '';
    toast('Repository added - cloning and indexing in background');
    loadRepos();
    refreshRepoFilter();

    // Start polling
    if (!repoPolling) {
      repoPolling = setInterval(() => { loadRepos(); refreshRepoFilter(); }, 3000);
    }
  } catch (err) {
    toast('Failed to add repo: ' + err.message);
  }
}

async function deleteRepo(id) {
  if (!confirm('Delete this repository and all its index data?')) return;

  try {
    await fetch(API + `/api/repos/${id}`, { method: 'DELETE' });
    selectedRepoIds.delete(id);
    toast('Repository deleted');
    loadRepos();
    refreshRepoFilter();
  } catch (err) {
    toast('Failed to delete: ' + err.message);
  }
}

async function reindexRepo(id) {
  try {
    const resp = await fetch(API + `/api/repos/${id}/reindex`, { method: 'POST' });
    if (!resp.ok) {
      const err = await resp.text();
      throw new Error(err);
    }
    toast('Re-indexing embeddings in background');
    loadRepos();

    if (!repoPolling) {
      repoPolling = setInterval(() => { loadRepos(); refreshRepoFilter(); }, 3000);
    }
  } catch (err) {
    toast('Failed to re-index: ' + err.message);
  }
}

// ── Settings ─────────────────────────────────────
async function loadConfig() {
  try {
    const resp = await fetch(API + '/api/config');
    const cfg = await resp.json();

    document.getElementById('cfg-provider').value = cfg.provider;
    document.getElementById('cfg-base-url').value = cfg.base_url;
    document.getElementById('cfg-chat-model').value = cfg.chat_model;
    document.getElementById('cfg-embed-model').value = cfg.embedding_model;
    document.getElementById('cfg-embed-dim').value = cfg.embedding_dim;
    document.getElementById('cfg-api-key').value = '';
    document.getElementById('cfg-api-key').placeholder = cfg.has_api_key ? '(key is set - enter new value to change)' : 'sk-...';
  } catch (err) {
    toast('Failed to load config: ' + err.message);
  }
}

async function saveConfig() {
  const update = {
    provider: document.getElementById('cfg-provider').value,
    // base_url is immutable at runtime (env var only) — not sent
    chat_model: document.getElementById('cfg-chat-model').value,
    embedding_model: document.getElementById('cfg-embed-model').value,
    embedding_dim: parseInt(document.getElementById('cfg-embed-dim').value) || 768,
  };

  const apiKey = document.getElementById('cfg-api-key').value;
  if (apiKey) update.api_key = apiKey;

  try {
    const resp = await fetch(API + '/api/config', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(update),
    });

    if (!resp.ok) throw new Error(await resp.text());
    toast('Configuration saved');
  } catch (err) {
    toast('Failed to save config: ' + err.message);
  }
}

// ── Utilities ────────────────────────────────────
function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}

// Initial load
loadRepos();
refreshRepoFilter();
</script>
</body>
</html>
